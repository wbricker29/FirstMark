# AIdev Workflow Details

## Table of Contents

- [File Structure](#file-structure)
- [Core Principles](#core-principles)
- [PRD Structure & Maintenance](#prd-structure--maintenance)
- [Template Management](#template-management)
- [Workflow Sequences](#workflow-sequences)
- [Pre-Implementation Checks (/work)](#pre-implementation-checks-work)
- [Automation Hooks](#automation-hooks)
- [Task Schema](#task-schema)
- [Testing Philosophy](#testing-philosophy)
- [Code Search Strategies](#code-search-strategies)
- [Context Scope Management](#context-scope-management)

---

## File Structure

The AIdev system organizes projects using a canonical directory structure:

```
spec/
├── constitution.md         # Project governance (non-negotiable)
├── PRD.md                 # Project requirements (unified document)
└── units/###-SLUG/        # Per-feature directories
    ├── design.md          # Stable architecture & design intent
    └── plan.md            # Volatile task execution (≤75 lines)

supabase/
├── migrations/            # Database schema migrations (run once)
│   ├── README.md         # Migration guidelines
│   ├── 000-004_*.sql     # Setup migrations
│   ├── YYYYMMDDHHMMSS_NNN_X_*.sql  # Feature migrations
│   └── EXECUTE_*.md      # Execution instructions
└── bau/                  # Business-as-usual operations (run repeatedly)
    ├── README.md
    ├── reset_database.sql
    ├── check_indexes.sql
    └── table_statistics.sql

reports/
└── vitest-report.json    # Test results (auto-generated, gitignored)

.claude/
├── commands/              # Workflow commands
├── hooks/                # Automation (format, test, state, git)
└── logs/
    └── state.json        # Derived state (auto-generated, never edit)
```

## Core Principles

### Single Source of Truth

Establish one authoritative location for each type of information:

- **spec/PRD.md** — All project requirements
  - Single unified document with standard sections (Problem, Outcomes, Success Metrics, Scope, Acceptance Criteria, Roadmap)
  - Links to unit directories for implementation details (reference-based, NOT duplicating content)

- **spec/units/###-SLUG/design.md** — Stable architecture and design intent per feature
  - Architecture decisions, design rationale, dependencies
  - Maintains single source of truth for feature design
  - Can exceed 75 lines (stable reference document)

- **spec/units/###-SLUG/plan.md** — Volatile task execution per feature
  - Task breakdown with checkboxes, priorities, estimates, evidence
  - YAML frontmatter for metadata
  - Should be ≤75 lines (archive completed tasks if exceeding)
  - Updated as work progresses

- **.claude/logs/state.json** — Derived progress metrics
  - Auto-generated by state-tracker.py hook
  - Never edit manually; reflects task completion status
  - Source for progress snapshots

**Maintenance Rules for PRD:**

1. DO NOT copy feature summaries from design.md or plan.md into PRD (link instead)
2. DO NOT manually track completion % in PRD (use state.json)
3. DO NOT duplicate task lists or completion criteria in PRD
4. DO keep unique strategic content (vision, NFRs, metrics, acceptance criteria)
5. DO link generously to canonical sources (design.md, plan.md)

**Reference-Based Principle:**
PRD should link to unit directories for implementation details, not duplicate them. Feature progress derives from state.json, not manual updates. Use `/check` command to view current progress instead of maintaining progress summaries in PRD.

### Constitutional Governance

Establish non-negotiable project principles:

- **spec/constitution.md** contains core principles that guide all decisions
- Violations block progress at /plan, /work, /check commands
- Updates require strong evidence (≥2 occurrences of violation patterns)
- Constitution checks prevent drift from foundational decisions

### Context Discipline

Maintain strict boundaries on work scope:

- **PRD**: Unified document across all features (no strict line limit, but keep concise by linking to units)
- **Design**: Stable architecture per feature (can exceed 75 lines)
- **Plan**: Task execution per feature (≤75 lines; archive completed tasks if exceeding)
- **Work**: ≤4 files modified, ≤100 LOC per task (complete single task, stop and split if exceeded)
- **If exceeded**: Stop work immediately and split task into smaller subtasks

### Evidence = Completion

A task is only complete when ALL THREE evidence elements are provided:

1. **Test output** — Actual command executed + full results
   - Example: `pnpm test -- src/components/Button.test.ts` output

2. **Code snippet** — Key implementation showing the change
   - Example: Core function implementation or critical diff

3. **Explanation** — 1-2 sentences explaining what was built and why
   - Example: "Implements debounced search to reduce API calls. Validation tests confirm input sanitization."

Without all three, mark task as incomplete and request additional evidence.

## PRD Structure & Maintenance

### PRD Content

Standard sections in a single unified document:

**Strategic Content (rarely changes):**

- Problem statement and audience
- Outcomes (primary and secondary)
- Success metrics (user engagement, technical performance, business outcomes)
- Scope (in-scope and out-of-scope)
- Acceptance criteria
- Constraints and assumptions

**Roadmap (updated periodically):**

- Milestones with target dates and deliverables
- Links to unit directories for implementation details
- High-level phase goals (NO detailed completion %)
- Run `/check` command to view current progress instead of tracking in PRD

**Reference-Based Maintenance:**

- Link to `spec/units/###-SLUG/` directories for implementation details
- Do NOT duplicate content from design.md or plan.md
- Use brief descriptions with links, not full summaries
- Example: `Feature 014: Corpus Analytics ([design](spec/units/014-corpus-analytics-remediation/design.md) | [plan](spec/units/014-corpus-analytics-remediation/plan.md))`

### Expanded PRD Variant (Optional)

Some teams prefer a single PRD that also orients stakeholders with a concise, link-first snapshot of feature status and current focus. This is supported as an optional “expanded PRD” variant for small projects, provided these rules are followed:

- Purpose: Orientation, not duplication. Keep PRD strategic; use links for details.
- Source of truth: Progress and numbers must come from automation (e.g., `.claude/logs/state.json`, `/status`, `/check`).
- No task lists: Do not copy task breakdowns from plan.md into PRD.

Allowed optional sections (link-first, concise):

- Feature Inventory: One-line per feature table with columns like `ID | Name | Status Tag | Documentation`. Optional `Effort Range` and `Blocks Deployment?` columns are acceptable. No raw task lists.
- Current Project State: A short narrative on phase/focus with explicit pointers to `.claude/logs/state.json` and `/status` for live metrics.
- Critical Path: Bulleted blockers with links to the relevant unit `plan.md` and evidence reports.
- Document Hierarchy: Brief orientation for new contributors showing how PRD, spec, design, and plan relate.

Formatting and hygiene rules:

- Percentages or counts shown in PRD must be noted as “derived from state.json” and include a date (e.g., “as of 2025-10-30”).
- Keep each feature summary to one line; link to `design.md` and `plan.md` for depth.
- Avoid duplicating acceptance criteria from unit docs; PRD maintains only project-level criteria.
- When in doubt, prefer links over prose. The PRD should stay readable without becoming a progress log.

### Maintenance Workflow

1. Edit YAML/markdown source files in unit directories (design.md, plan.md)
2. Run feature commands (/plan, /work, etc.)
3. After completion, update PRD roadmap with links to unit directories (no content duplication)
4. Run `/check` to verify progress is tracked in state.json
5. Keep PRD focused on strategy and outcomes; delegate implementation details to unit documents

## Template Management

### Template Location

**Single Source of Truth:** `.claude/skills/aidev-workflow/assets/templates/`

All workflow templates are stored in the skill's `assets/templates/` directory. Commands reference these templates directly from this location when generating new documents.

Available templates:

- **CONSTITUTION-TEMPLATE.md** — Project governance documents (used by `/constitution`)
- **PRD-TEMPLATE.md** — Product requirements documents (used by `/prd`)
- **SPEC-TEMPLATE.md** — Technical specifications (used by `/spec`)
- **DESIGN-TEMPLATE.md** — Detailed feature designs (used by `/new`)
- **PLAN-TEMPLATE.md** — Feature technical design (used by `/plan`)

### Template Format

All templates use Markdown format with YAML frontmatter for metadata.

### Editing Templates

**IMPORTANT:** Edit templates in `.claude/skills/aidev-workflow/assets/templates/` only. This is the canonical source that commands reference.

When you modify a template:

1. Edit the file directly in `assets/templates/`
2. Changes take effect immediately for new documents
3. Existing documents are not affected (they're independent copies)

Note: Some projects may have symlinks in `.claude/skills/aidev-workflow/assets/templates/` pointing to these files for convenience, but always edit the canonical source in the skill's `assets/templates/` directory to maintain consistency.

## Workflow Sequences

### One-Time Setup

Create foundational governance documents:

```
/constitution
  → spec/constitution.md (project governance, non-negotiable principles)
```

Run once per project to establish baseline principles.

### Per-Project Setup

Define project strategy:

```
/prd
  → spec/PRD.md (project requirements, unified document)
```

Run /prd once per project. Update iteratively as requirements evolve.

### Per-Feature Development

Plan, implement, and validate one feature at a time:

```
/plan FEATURE_NAME
  → spec/units/###-SLUG/design.md (stable architecture, constitution check)
  → spec/units/###-SLUG/plan.md (task execution)
  → Validates against constitution.md (blocks if violated)

/work NNN x.y
  → Implement single task (pre-checks before coding)
  → Pre-checks validate: constitution, dependencies, bounds, traceability
  → Requires evidence (test output + code snippet + explanation)

/check NNN
  → Validate feature quality (5 quality gates, fail-closed)
  → Gates: constitution, code style, test coverage, docs, integration

/reflect
  → Extract learnings from completed work
  → Keep 5-10 most recent patterns
  → Update CLAUDE.md Reflection Patterns section
```

Complete one feature at a time. Follow workflow in sequence: /plan → /work → /check → /reflect.

**Note on Phase Patterns**: The /work command uses a different phase naming pattern (UPEVD) compared to other commands. See the "Phase Naming Convention" section in commands-reference.md for details on this intentional distinction.

## Pre-Implementation Checks (/work)

Before running /work NNN x.y, verify four critical conditions:

### 1. Constitution Compliance

Verify the task does not violate project governance:

- Read spec/constitution.md
- Check if task aligns with core principles
- /work command auto-checks this (blocks if violated)

### 2. Task Not Blocked

Verify dependencies are complete:

- Read spec/units/###-SLUG/plan.md
- Check task's "Depends:" field in task list
- Confirm all dependencies are marked complete [x]
- /work command auto-checks this (fails if blocked)

### 3. Context Bounds

Verify task scope is manageable:

- ≤4 files can be modified
- ≤100 lines of code per task
- /work command warns if bounds exceeded (stop and split if needed)

### 4. Requirement Traceability

Verify task maps to project requirements:

- Find task in spec/units/###-SLUG/plan.md
- Check "Depends:" for parent feature/task
- Trace back to PRD feature description
- Confirm task implements part of planned feature

All four checks must pass before coding begins.

## Automation Hooks

Hooks run automatically at specific points in the workflow:

### Per-Edit Hooks (PostToolUse)

Run after each file change:

1. **format.sh** (~5-10s)
   - Auto-format code with Prettier
   - Runs on: .ts, .tsx, .js, .jsx, .css, .md, .json, .yaml files
   - Configure in: Prettier config files

2. **state-tracker.py** (~1-2s)
   - Auto-update state.json with task progress
   - Scans: spec/units/###-SLUG/plan.md checkboxes
   - Updates: .claude/logs/state.json completion percentages
   - Never edit state.json manually

### Per-Response Hooks (Stop)

Run once when Claude finishes:

1. **test.sh** (~60-120s)
   - Run full Vitest test suite
   - Disabled by default (ENABLE_TESTS=0)
   - Enable with: `export ENABLE_TESTS=1` before running Claude Code

2. **git-commit.sh** (~2s)
   - Auto-commit when parent tasks complete
   - Enabled by default (ENABLE_AUTOCOMMIT=1)
   - Disable with: `export ENABLE_AUTOCOMMIT=0` before running Claude Code

3. **notification**
   - Desktop notification (macOS/Linux only)
   - Alerts when tests/commits complete
   - Non-blocking (does not affect workflow)

### Toggle Controls

Set environment variables BEFORE running Claude Code:

```bash
# Enable tests (disabled by default)
export ENABLE_TESTS=1

# Disable tests
export ENABLE_TESTS=0

# Enable auto-commits (enabled by default)
export ENABLE_AUTOCOMMIT=1

# Disable auto-commits
export ENABLE_AUTOCOMMIT=0
```

Check `.claude/settings.json` for hook configuration. Test suite disabled by default; enable after ensuring tests pass consistently.

## Task Schema

Standardize task format in plan.md files:

```markdown
- [ ] 1.1 Task title | Priority: High | Est: 30m | Depends: #1.0
- [x] 1.2 Completed ✅ 2025-01-15 14:30
- [!] 2.1 Blocked (waiting on dependency)
```

**Components:**

- Checkbox: `[ ]` (pending), `[x]` (completed), `[!]` (blocked)
- Task ID: `1.1`, `1.2` (feature.number format)
- Title: Clear, verb-first description
- Priority: High, Medium, Low (optional)
- Estimate: 30m, 1h, 2h, etc. (optional)
- Depends: `#1.0` or none (optional)
- Timestamp: Added when task completed (optional)

Maintain consistency across all plan.md files. Task ID format must match ###-SLUG/plan.md numbering scheme.

## Testing Philosophy

Test implementation follows these principles:

- **Framework**: Vitest for unit and integration tests
- **Performance**: Keep suite fast (≤60s total runtime)
- **Coverage**: Target ≥80% coverage on modified modules
- **Edge Cases**: Include ≥1 edge case per feature
- **AI Features**: Test with ≥5 real queries (see constitution)
- **Execution**:
  - Single run: `pnpm test`
  - Watch mode: `pnpm test:watch`
  - Specific file: `pnpm test -- src/components/Button.test.ts`
- **Results**: Stored in `reports/vitest-report.json` (gitignored)

Integration tests should cover data flow end-to-end. Unit tests should cover critical logic. Edge case tests should verify boundary conditions and error handling.

## Code Search Strategies

Use appropriate tools for different search types:

**Structural/Syntax Searches** → Use `ast-grep` with language flag:

- TypeScript: `ast-grep --lang typescript 'pattern'`
- TSX/React: `ast-grep --lang tsx 'pattern'`
- JavaScript: `ast-grep --lang javascript 'pattern'`
- JSX: `ast-grep --lang jsx 'pattern'`

**Text/Pattern Searches** → Use `Grep` tool:

- Regex patterns across files
- Configuration values
- String literals
- Comments and documentation

**File Finding** → Use `Glob` tool:

- File pattern matching
- Wildcard searches
- Extension-based searches

Combine searches to thoroughly understand code before making changes.

## Context Scope Management

Manage information scope to stay focused:

**Avoid context bloat:**

- Don't read entire files unless necessary (use line offsets)
- Search specific patterns instead of full file reads
- Link to sections rather than copying content
- Focus on relevant excerpts

**Stay within bounds:**

- ≤75 lines for plan.md (archive completed tasks if exceeding)
- Design.md can exceed 75 lines (stable reference)
- ≤100 LOC per /work task
- ≤4 files modified per task
- Stop and split if bounds exceeded

**Maintain traceability:**

- Link features to PRD requirements
- Link tasks to feature plans
- Link commits to task completion
- Use /check for progress snapshots and alignment validation

Discipline maintains clarity and prevents information overload.
